<?xml version="1.0" encoding="UTF-8"?>
<chapter id ="AISDashboard">
    <title>Dashboard and Visualization of Ship Trajectories (AIS)</title>
        <para>
        This module builds on the Managing Ship Trajectories (AIS) module by creating a business intelligence dashboard to visualize and manipulate data. The module shows how to setup a Grafana dashboard with an existing database, create basic visualizations, set properties for different outputs, and use Variables to create dynamic visuals.
        </para>

        <section>
            <title>Contents</title>
            <para>
                This module covers the following topics:
				<itemizedlist>
                    <listitem>
                        <para>Setting up a Grafana dashboard and connecting to a database</para>
                    </listitem>
                    <listitem>
                        <para>Visualize a statistic from simple aggregations</para>
                    </listitem>
                    <listitem>
                        <para>Visualize spatial frequency with a heat-map (not aggregated)</para>
                    </listitem>
                    <listitem>
                        <para>Visualize frequency in spatial extent with a heat-map (pre-aggregated)</para>
                    </listitem>
                    <listitem>
                        <para>Visualize spatio-temporal proximate objects</para>
                    </listitem>
                    <listitem>
                        <para>Create dynamic queries with variables</para>
                    </listitem>
                </itemizedlist>
            </para>
        </section>

        <section>
            <title>Tools</title>
            <para>
                The tools used in this module are as follows:
                <itemizedlist>
                    <listitem>
                        <para>MobilityDB, on top of PostgreSQL and PostGIS</para>
                    </listitem>
                    <listitem>
                        <para>QGIS</para>
                    </listitem>
                    <listitem>
                        <para>Grafana</para>
                    </listitem>
                </itemizedlist>
            </para>
    </section>

        <section>
            <title>Setting up Visualization Dashboard</title>
            <para>We can use <ulink url="https://grafana.com">Grafana</ulink>, an open-source technology, to create a business intelligence dashboard. This will allow different users to setup their own queries and visualizations, or easily slice through data in a visual way for non-technical users.</para>
            <para>Start by setting up Grafana on your system:
                <itemizedlist>
                    <listitem>
                        <para><ulink url="https://grafana.com/docs/grafana/latest/setup-grafana/installation/mac/">macOS</ulink>
                            <programlisting>
brew update
brew install grafana
brew services start grafana
                            </programlisting>
                        </para>
                        <para><ulink url="https://grafana.com/docs/grafana/latest/setup-grafana/installation/debian/">Debian or Ubuntu</ulink>
                            <programlisting>
# Note These are instructions for Grafana Enterprise Edition (via APT repository), which they recommend. It includes all the Open Source features and can also use Enterprise
# features if you have a License.

# Setup Grafana Keys
sudo apt-get install -y apt-transport-https
sudo apt-get install -y software-properties-common wget
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -

# Add repository for stable releases
echo "deb https://packages.grafana.com/enterprise/deb stable main" | sudo tee -a /etc/apt/sources.list.d/grafana.list

# Install Grafana
sudo apt-get update
sudo apt-get install grafana-enterprise
                            </programlisting>
                        </para>
                        <para><ulink url="https://grafana.com/docs/grafana/latest/setup-grafana/installation/windows/">Windows</ulink>
                        </para>
                    </listitem>
                </itemizedlist>
            </para>
        </section>

    <section>
            <title>Sign in and Connect to Data Source</title>
            <para>We can now sign in to Grafana by going to <ulink url="http://localhost:3000/">http://localhost:3000/</ulink>. Setup a new account if needed. Additional instructions to 
            login can be found here following the <ulink url="https://grafana.com/docs/grafana/latest/getting-started/build-first-dashboard/">build your first dashboard instructions</ulink>.</para>
            <para>Next, we add a data source for Grafana to interact with. In this case, we can follow the <ulink url="https://grafana.com/docs/grafana/latest/datasources/add-a-data-source/">
            Grafana instructions for adding a data source</ulink> and search for <ulink url="https://grafana.com/docs/grafana/latest/datasources/postgres/">PostgreSQL</ulink> as the data source.</para>
            <para>The workshop is using the following settings to connect to the postgres server on Azure.</para>

				<itemizedlist>
                    <listitem>
                        <para>Name: DanishAIS</para>
                    </listitem>
                    <listitem>
                        <para>Host: 20.79.254.53:5432</para>
                    </listitem>
                    <listitem>
                        <para>Database: danishais</para>
                    </listitem>
                    <listitem>
                        <para>User: mobilitydb-guest</para>
                    </listitem>
                    <listitem>
                        <para>Password: mobilitydb@guest</para>
                    </listitem>
                    <listitem>
                        <para>TLS/SSL Mode: disable</para>
                    </listitem>
                    <listitem>
                        <para>Version: 12+</para>
                    </listitem>
                </itemizedlist>

        <para>Then press save and test</para>
        <figure id="imgvizDataSrcPostgres" float="start"><title>Data Source Postgres Settings</title>
            <mediaobject>
                <imageobject><imagedata width='80%' fileref='images/vizDataSrcPostgres.png'/></imageobject>
            </mediaobject>
        </figure>


    </section>


    <section>
        <title>Creating a Dashboard</title>
            <para>With the dashboard setup and configure, we will now build different panels to visualize data in intuitive ways.</para>
        <section>
            <title>Speed of Individual Ships</title>
            <para>Let’s visualize the speed of the ships using the previously build query. Here we will represent it as a statistic with a color gradient.
                <orderedlist>
                    <listitem></listitem>

                    <listitem><para>Add a new panel</para></listitem>
                    <listitem><para>Select *DanishAIS* as the data source</para></listitem>
                    <listitem><para>In Format as, change “Time series” to “Table” and choose “Edit SQL”</para></listitem>
                    <listitem><para>Here you can add your SQL queries. Let’s replace the exist query with the following SQL script:
                        <programlisting>
SELECT mmsi, ABS(twavg(SOG) * 1.852 - twavg(speed(Trip))* 3.6 ) AS SpeedDifference
FROM Ships
ORDER BY SpeedDifference DESC
LIMIT 5;
                        </programlisting>
                    </para></listitem>
                    <listitem><para>We can also quickly do some datatype transformations to help Grafana correctly interpret the incoming data. Next to the Query button, select “Transform”, add “Convert field type” and choose mmsi as String.</para></listitem>
                        <figure id="imgvizconverttype" float="start"><title>Convert type</title>
				            <mediaobject>
					            <imageobject><imagedata width='80%' fileref='images/vizConvertType.png'/></imageobject>
				            </mediaobject>
			            </figure>
                    <listitem>
                        <para>We will modify some of the visualization options in the panel on the right.</para>
                        <para>First, choose stat as the visualization</para>
                        <figure id="imgvizchoosetype" float="start"><title>Convert type</title>
				            <mediaobject>
					            <imageobject><imagedata width='80%' fileref='images/vizChooseType.png'/></imageobject>
				            </mediaobject>
			            </figure>
                        <para>Panel Options: Give the panel the title <italic> Incorrect AIS Boat Speed Reporting</italic></para>
                        <para>Value Options:
                                <listitem>
                                    <para>Show: All values</para>
                                </listitem>
                                <listitem>
                                    <para>Fields: speeddifference</para>
                                    <para>Note: we can include a limit here instead of in our SQL query as well.</para>
                                </listitem>
                        </para>
                    </listitem>


                </orderedlist>
            </para>
        </section>
        <section>
            <title>Routes Used Most Frequently Visualized with a Static Heat Map</title>
        </section>
        <section>
            <title>Number of Boats Moving Through a Given Area</title>
        </section>
        <section>
            <title>Boats in Close Proximity in a Given Time Range</title>
        </section>
        <section>
            <title>Routes Used Most Frequently Visualized with a Static Heat Map</title>
        </section>
    </section>

    <section>
        <title>Dynamic Dashboards - Using Variables to Manipulate Queries</title>
        <section>
            <title>Creating Variable</title>
        </section>
        <section>
            <title>Dynamic Query: Number of Boats Moving Through a Given Area in a Certain Time Period</title>
        </section>
    </section>


</chapter>